"use strict";(()=>{var e={};e.id=486,e.ids=[486],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},2254:e=>{e.exports=require("node:buffer")},4492:e=>{e.exports=require("node:stream")},2794:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>x,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{GET:()=>d,dynamic:()=>l,runtime:()=>c});var o=t(9303),a=t(8716),n=t(670),i=t(7070),u=t(2099),p=t(7030);let c="nodejs",l="force-dynamic";async function d(e){if(!function(e){let r=e.headers.get("authorization"),t=process.env.CRON_SECRET;return!!t&&r===`Bearer ${t}`}(e))return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:r,error:t}=await p.O.from("participants").select("id, line_user_id");if(t)return i.NextResponse.json({error:t.message},{status:500});if(!r?.length)return i.NextResponse.json({message:"No participants"});let s=new Date(Date.now()-6048e5).toISOString(),o=[];for(let e of r){let{data:r}=await p.O.from("chat_logs").select("role, content, created_at").eq("participant_id",e.id).gte("created_at",s).order("created_at",{ascending:!0}),t=(r?.length??0)>0?`今週のふりかえり（β）
- よく出た気持ち: …
- 印象的な出来事: …
- 来週ためしたいこと: …
※自動生成の簡易版です。`:"今週の記録は見当たりませんでした。来週も無理なく少しずつ✍️";try{await u.d.pushMessage(e.line_user_id,{type:"text",text:t}),o.push({userId:e.line_user_id,status:"success"})}catch(r){await p.O.from("line_push_errors").insert({line_user_id:e.line_user_id,payload:{text:t},error:r?.message??String(r)}),o.push({userId:e.line_user_id,status:"error",error:r?.message??String(r)})}}return i.NextResponse.json({sent:o.filter(e=>"success"===e.status).length,errors:o.filter(e=>"error"===e.status)})}let m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/cron/weekly-summary/route",pathname:"/api/cron/weekly-summary",filename:"route",bundlePath:"app/api/cron/weekly-summary/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\momo-LINE\\src\\app\\api\\cron\\weekly-summary\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:_,serverHooks:g}=m,h="/api/cron/weekly-summary/route";function y(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},2099:(e,r,t)=>{t.d(r,{d:()=>a});var s=t(8077);let o={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN||"",channelSecret:process.env.LINE_CHANNEL_SECRET||""},a=new s.Z(o)},7030:(e,r,t)=>{t.d(r,{O:()=>n});var s=t(9498);let o="https://mkikyycrgfudodhkukng.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"sb_secret_15fRJCpoYBkRlTa3cJIXUjg_Ajskglr1";console.log("Supabase URL:",o),console.log("Supabase Service Key exists:",!!a);let n=(0,s.eI)(o,a)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,601],()=>t(2794));module.exports=s})();