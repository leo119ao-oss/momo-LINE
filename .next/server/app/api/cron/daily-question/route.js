"use strict";(()=>{var e={};e.id=501,e.ids=[501],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},2254:e=>{e.exports=require("node:buffer")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},2868:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>g,requestAsyncStorage:()=>q,routeModule:()=>x,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{GET:()=>m,dynamic:()=>d,runtime:()=>l});var o=t(9303),i=t(8716),a=t(670),n=t(7070),u=t(8316),p=t(2099),c=t(4214);let d="force-dynamic",l="nodejs";async function m(e){if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=new c.default({apiKey:process.env.OPENAI_API_KEY}),{data:t}=await u.supabaseAdmin.from("users").select("line_user_id, participants!inner(id)"),{data:s}=await u.supabaseAdmin.from("recent_user_queries").select("*"),o=new Map(s?.map(e=>[e.participant_id,e.query_blob||""])),i=0;for(let e of t||[])try{let t=e.participants.id,s=(o.get(t)||"子育て 内省 生活 家族").slice(0,800),a=await r.embeddings.create({model:"text-embedding-3-small",input:s}),{data:n}=await u.supabaseAdmin.rpc("match_documents_arr",{query_embedding:a.data[0].embedding,match_count:5}),c=(n||[])[0];if(!c)continue;let d=`抜粋:
${(c.content||"").slice(0,1200)}
URL:${c.source_url}`,l=await r.chat.completions.create({model:"gpt-4o-mini",temperature:.3,messages:[{role:"system",content:"優しい編集者。記事の要点を3行で要約し、最後に「今日は〜を意識してみる？」の1行。装飾禁止。箇条書きは「・」。"},{role:"user",content:d}]}),m=l.choices[0].message.content?.trim()||"";await p.d.pushMessage(e.line_user_id,{type:"text",text:`おはよう。
今日のおすすめだよ。

${m}

${c.source_url}`}),i++}catch(e){console.error("morning-reco error",e)}return n.NextResponse.json({sent:i})}let x=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/daily-question/route",pathname:"/api/cron/daily-question",filename:"route",bundlePath:"app/api/cron/daily-question/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\momo-LINE\\src\\app\\api\\cron\\daily-question\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:q,staticGenerationAsyncStorage:_,serverHooks:h}=x,y="/api/cron/daily-question/route";function g(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},2099:(e,r,t)=>{t.d(r,{d:()=>i});var s=t(8077);let o={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN||"",channelSecret:process.env.LINE_CHANNEL_SECRET||""},i=new s.Z(o)},8316:(e,r,t)=>{t.d(r,{supabaseAdmin:()=>s});let s=(0,t(9498).eI)("https://mkikyycrgfudodhkukng.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,766,70,77,214],()=>t(2868));module.exports=s})();