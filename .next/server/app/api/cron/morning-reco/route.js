"use strict";(()=>{var e={};e.id=55,e.ids=[55],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},2254:e=>{e.exports=require("node:buffer")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},6462:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>l,routeModule:()=>m,serverHooks:()=>x,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{GET:()=>d});var n=t(9303),o=t(8716),i=t(670),a=t(7070),p=t(8316),u=t(2099);let c=new(t(4214)).default({apiKey:process.env.OPENAI_API_KEY});async function d(e){if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{data:r}=await p.supabaseAdmin.from("users").select("line_user_id, participants!inner(id,last_morning_sent_at)").limit(5e3),{data:t}=await p.supabaseAdmin.from("recent_user_queries").select("*"),s=new Map(t?.map(e=>[e.participant_id,e.query_blob||""])),n=[];for(let e of r||[])try{let r=e.participants[0].id,t=(s.get(r)||"子育て 雑記 内省 生活 家族").slice(0,800),o=await c.embeddings.create({model:"text-embedding-3-small",input:t}),{data:i}=await p.supabaseAdmin.rpc("match_documents_arr",{query_embedding:o.data[0].embedding,match_count:5}),a=(i||[]).slice(0,1);if(!a.length)continue;let d=a[0],m=`記事抜粋:
${d.content.slice(0,1200)}
URL:${d.source_url}`,l=await c.chat.completions.create({model:"gpt-4o-mini",temperature:.3,messages:[{role:"system",content:"あなたは優しい編集者。記事の要点を3行で要約し、最後に「今日は〜を意識してみる？」の1行を添える。箇条書きは「・」。Markdown装飾は禁止。"},{role:"user",content:m}]}),_=l.choices[0].message.content?.trim()||"";await u.d.pushMessage(e.line_user_id,{type:"text",text:`おはよう。
今日のおすすめだよ。

${_}

${d.source_url}`}),await p.supabaseAdmin.from("participants").update({last_morning_sent_at:new Date().toISOString()}).eq("id",r),n.push({ok:e.line_user_id})}catch(r){n.push({ng:e?.line_user_id,e:String(r)})}return a.NextResponse.json({sent:n.length,results:n})}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/morning-reco/route",pathname:"/api/cron/morning-reco",filename:"route",bundlePath:"app/api/cron/morning-reco/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\momo-LINE\\src\\app\\api\\cron\\morning-reco\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:_,serverHooks:x}=m,g="/api/cron/morning-reco/route";function h(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:_})}},2099:(e,r,t)=>{t.d(r,{d:()=>o});var s=t(8077);let n={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN||"",channelSecret:process.env.LINE_CHANNEL_SECRET||""},o=new s.Z(n)},8316:(e,r,t)=>{t.d(r,{supabaseAdmin:()=>s});let s=(0,t(9498).eI)("https://mkikyycrgfudodhkukng.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,766,70,77,214],()=>t(6462));module.exports=s})();