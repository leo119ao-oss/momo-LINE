"use strict";(()=>{var e={};e.id=457,e.ids=[457],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},2254:e=>{e.exports=require("node:buffer")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},9442:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>q,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>E,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>y,dynamic:()=>g,runtime:()=>m});var o=r(9303),a=r(8716),i=r(670),n=r(7070),l=r(2254);let p=require("node:crypto");var c=r(2099),u=r(8157),d=r(8316);let m="nodejs",g="force-dynamic";async function x(e){console.log("IMG_EVENT: Processing image message",e.message.id);let t=e.source.userId;try{let s=await c.d.getMessageContent(e.message.id),o=[];for await(let e of s)o.push(e);let a=Buffer.concat(o),i=`images/${t}/${e.message.id}.jpg`,{data:n,error:l}=await d.supabaseAdmin.storage.from("media").upload(i,a,{contentType:"image/jpeg",upsert:!0});if(l)throw console.error("Storage upload error:",l),l;let{publicUrl:p}=d.supabaseAdmin.storage.from("media").getPublicUrl(i).data;console.log("IMG_EVENT: Image saved to",p);let u=new(await Promise.resolve().then(r.bind(r,4214))).default({apiKey:process.env.OPENAI_API_KEY}),m=((await u.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"写真を見て情景を1文で。断定しすぎず、やさしい文体。"},{role:"user",content:[{type:"text",text:"この画像の情景。短い名詞句ではなく1文で。"},{type:"image_url",image_url:{url:p}}]}],temperature:.6})).choices[0].message.content||"").trim();console.log("IMG_EVENT: Generated base description:",m);let g=((await u.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"次の文から、日記のキャプション候補を日本語で3つ。15〜28字。言い切り or 〜だなあ調。絵文字や記号なし。"},{role:"user",content:m}],temperature:.7})).choices[0].message.content||"").split(/\n+/).map(e=>e.replace(/^\d+[\).、]\s*/,"")).filter(Boolean).slice(0,3);console.log("IMG_EVENT: Generated candidates:",g);let{data:x}=await d.supabaseAdmin.from("participants").select("id").eq("line_user_id",t).single();await d.supabaseAdmin.from("media_entries").insert({participant_id:x.id,image_url:p,guess:m,suggested_caption:JSON.stringify(g),ask_stage:1,status:"awaiting"}),console.log("IMG_EVENT: Saved to media_entries with candidates");let y=`素敵な1枚だね。これは「${m}」って感じかな？

キャプション案：
1) ${g[0]}
2) ${g[1]||""}
3) ${g[2]||""}

近い番号を教えてね。ぜんぶ違えば、理想の文をそのまま送ってくれて大丈夫！`;await c.d.replyMessage(e.replyToken,{type:"text",text:y}),console.log("IMG_EVENT: Sent response with candidates")}catch(t){console.error("IMG_EVENT: Error processing image:",t),await c.d.replyMessage(e.replyToken,{type:"text",text:"画像の処理でエラーが発生しました。もう一度お試しください。"})}}async function y(e){var t,s,o,a;let i=await e.text(),m=e.headers.get("x-line-signature")||"";if(t=process.env.LINE_CHANNEL_SECRET,o=(0,p.createHmac)("SHA256",t).update(i).digest(),s="base64",a=l.Buffer.from(m,s),!(o.length===a.length&&(0,p.timingSafeEqual)(o,a)))return console.error("Signature validation failed"),n.NextResponse.json({error:"Unauthorized"},{status:401});let g=JSON.parse(i).events;console.log(`Received ${g.length} webhook events`);try{for(let e of g){if("message"===e.type&&"image"===e.message.type){await x(e);continue}if("message"===e.type&&"text"===e.message.type){let t=e.source.userId,s=e.message.text;console.log(`Processing message from user ${t}: ${s.substring(0,50)}...`);try{let{data:o}=await d.supabaseAdmin.from("participants").select("id").eq("line_user_id",t).single(),{data:a}=await d.supabaseAdmin.from("media_entries").select("*").eq("participant_id",o.id).eq("status","awaiting").order("created_at",{ascending:!1}).limit(1);if(a&&a.length){let t=a[0],o=new(await Promise.resolve().then(r.bind(r,4214))).default({apiKey:process.env.OPENAI_API_KEY}),i=`画像メモ: ${t.guess}
ユーザーの追記: ${s}
→ 30〜60字の一文キャプションで。`,n=await o.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"あなたは写真日記の編集者。ユーザーの一言を活かし、やさしい1文キャプションを作る。"},{role:"user",content:i}],temperature:.3}),l=n.choices[0].message.content?.trim()||s.trim();await d.supabaseAdmin.from("media_entries").update({user_answer:s,caption:l,status:"done"}).eq("id",t.id),await c.d.replyMessage(e.replyToken,{type:"text",text:`できたよ。
「${l}」
（このあと一覧ページも作れるようにするね）
${t.image_url}`});continue}let i=await (0,u.zb)(t,s);await c.d.replyMessage(e.replyToken,{type:"text",text:i}),console.log(`Successfully replied to user ${t}`)}catch(r){console.error(`Error handling message from user ${t}:`,r);try{await c.d.replyMessage(e.replyToken,{type:"text",text:"すみません、一時的にエラーが発生しました。しばらく時間をおいてから、もう一度お試しください。"})}catch(e){console.error("Failed to send error message:",e)}}}else if("follow"===e.type){let t=e.source.userId;console.log(`New user followed: ${t}`);try{await c.d.replyMessage(e.replyToken,{type:"text",text:"Momo AIパートナーへようこそ！\n\nあなたの内省を支援する、温かいパートナーとして、いつでもお話をお聞かせください。\n\n毎朝9時に小さな問いをお送りし、週末には一週間の振り返りをお届けします。"})}catch(e){console.error("Error sending welcome message:",e)}}}}catch(e){return console.error("Error processing webhook event:",e),n.NextResponse.json({error:"Internal Server Error"},{status:500})}return n.NextResponse.json({status:"ok"})}let w=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/line/webhook/route",pathname:"/api/line/webhook",filename:"route",bundlePath:"app/api/line/webhook/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\momo-LINE\\src\\app\\api\\line\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:E}=w,_="/api/line/webhook/route";function q(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:f})}},2099:(e,t,r)=>{r.d(t,{d:()=>a});var s=r(8077);let o={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN||"",channelSecret:process.env.LINE_CHANNEL_SECRET||""},a=new s.Z(o)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,498,972,77,214,157],()=>r(9442));module.exports=s})();