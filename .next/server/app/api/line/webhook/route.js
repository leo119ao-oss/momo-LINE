"use strict";(()=>{var e={};e.id=457,e.ids=[457],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},2254:e=>{e.exports=require("node:buffer")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},9442:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>b,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>w,dynamic:()=>g,runtime:()=>m});var a=r(9303),o=r(8716),i=r(670),n=r(7070),p=r(2254);let u=require("node:crypto");var l=r(2099),d=r(838),c=r(8316);let m="nodejs",g="force-dynamic";async function x(e){let t=e.source.userId,s=await l.d.getMessageContent(e.message.id),a=[];for await(let e of s)a.push(e);let o=Buffer.concat(a),i=`images/${t}/${e.message.id}.jpg`,{data:n,error:p}=await c.supabaseAdmin.storage.from("media").upload(i,o,{upsert:!0,contentType:"image/jpeg"});if(p)throw p;let{data:u}=c.supabaseAdmin.storage.from("media").getPublicUrl(i),d=u.publicUrl,m=new(await Promise.resolve().then(r.bind(r,4214))).default({apiKey:process.env.OPENAI_API_KEY}),g=await m.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"あなたは写真をやさしく説明する編集者。1文で「〜っぽいね」のトーン。"},{role:"user",content:[{type:"text",text:"この画像は何に見える？1文で"},{type:"image_url",image_url:{url:d}}]}],temperature:.2}),x=g.choices[0].message.content?.trim()||"日常の一コマかな？",{data:w}=await c.supabaseAdmin.from("participants").select("id").eq("line_user_id",t).single();await c.supabaseAdmin.from("media_entries").insert({participant_id:w.id,image_url:d,guess:x,status:"awaiting"}),await l.d.replyMessage(e.replyToken,{type:"text",text:`${x}
あってる？ ひとこと教えてくれたら、絵日記のキャプションに仕立てるね。`})}async function w(e){var t,s,a,o;let i=await e.text(),m=e.headers.get("x-line-signature")||"";if(t=process.env.LINE_CHANNEL_SECRET,a=(0,u.createHmac)("SHA256",t).update(i).digest(),s="base64",o=p.Buffer.from(m,s),!(a.length===o.length&&(0,u.timingSafeEqual)(a,o)))return console.error("Signature validation failed"),n.NextResponse.json({error:"Unauthorized"},{status:401});let g=JSON.parse(i).events;console.log(`Received ${g.length} webhook events`);try{for(let e of g){if("message"===e.type&&"image"===e.message.type){await x(e);continue}if("message"===e.type&&"text"===e.message.type){let t=e.source.userId,s=e.message.text;console.log(`Processing message from user ${t}: ${s.substring(0,50)}...`);try{let{data:a}=await c.supabaseAdmin.from("participants").select("id").eq("line_user_id",t).single(),{data:o}=await c.supabaseAdmin.from("media_entries").select("*").eq("participant_id",a.id).eq("status","awaiting").order("created_at",{ascending:!1}).limit(1);if(o&&o.length){let t=o[0],a=new(await Promise.resolve().then(r.bind(r,4214))).default({apiKey:process.env.OPENAI_API_KEY}),i=`画像メモ: ${t.guess}
ユーザーの追記: ${s}
→ 30〜60字の一文キャプションで。`,n=await a.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"あなたは写真日記の編集者。ユーザーの一言を活かし、やさしい1文キャプションを作る。"},{role:"user",content:i}],temperature:.3}),p=n.choices[0].message.content?.trim()||s.trim();await c.supabaseAdmin.from("media_entries").update({user_answer:s,caption:p,status:"done"}).eq("id",t.id),await l.d.replyMessage(e.replyToken,{type:"text",text:`できたよ。
「${p}」
（このあと一覧ページも作れるようにするね）
${t.image_url}`});continue}let i=await (0,d.zb)(t,s);await l.d.replyMessage(e.replyToken,{type:"text",text:i}),console.log(`Successfully replied to user ${t}`)}catch(r){console.error(`Error handling message from user ${t}:`,r);try{await l.d.replyMessage(e.replyToken,{type:"text",text:"すみません、一時的にエラーが発生しました。しばらく時間をおいてから、もう一度お試しください。"})}catch(e){console.error("Failed to send error message:",e)}}}else if("follow"===e.type){let t=e.source.userId;console.log(`New user followed: ${t}`);try{await l.d.replyMessage(e.replyToken,{type:"text",text:"Momo AIパートナーへようこそ！\n\nあなたの内省を支援する、温かいパートナーとして、いつでもお話をお聞かせください。\n\n毎朝9時に小さな問いをお送りし、週末には一週間の振り返りをお届けします。"})}catch(e){console.error("Error sending welcome message:",e)}}}}catch(e){return console.error("Error processing webhook event:",e),n.NextResponse.json({error:"Internal Server Error"},{status:500})}return n.NextResponse.json({status:"ok"})}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/line/webhook/route",pathname:"/api/line/webhook",filename:"route",bundlePath:"app/api/line/webhook/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\momo-LINE\\src\\app\\api\\line\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:q}=f,_="/api/line/webhook/route";function b(){return(0,i.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:h})}},2099:(e,t,r)=>{r.d(t,{d:()=>o});var s=r(8077);let a={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN||"",channelSecret:process.env.LINE_CHANNEL_SECRET||""},o=new s.Z(a)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,62,77,214,838],()=>r(9442));module.exports=s})();